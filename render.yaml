services:
  # ----------------------------
  # API (Spring Boot)
  # ----------------------------
  - type: web
    name: itinventory-api
    runtime: docker
    plan: free
    autoDeploy: true
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: docker

      # MySQL (Private Service)
      # ATENÇÃO: no Render, o Service Address do MySQL costuma ser :10000
      - key: SPRING_DATASOURCE_URL
        value: jdbc:mysql://itinventory-mysql:10000/itinventory_equip?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - key: SPRING_DATASOURCE_USERNAME
        value: itinv
      - key: SPRING_DATASOURCE_PASSWORD
        value: itinv123

      # Elasticsearch (Private Service)
      - key: SEARCH_ES_ENABLED
        value: "true"
      - key: SEARCH_ES_HOST
        value: itinventory-es
      - key: SEARCH_ES_PORT
        value: "9200"
      - key: SEARCH_ES_INDEX
        value: itinventory-equipments

  # ----------------------------
  # MySQL (Private Service)
  # Observação: como o painel está apontando para docker/infra/Dockerfile,
  # crie esse arquivo (docker/infra/Dockerfile) copiando a lógica de init.
  # ----------------------------
  - type: pserv
    name: itinventory-mysql
    runtime: docker
    plan: starter
    autoDeploy: true
    rootDir: docker/infra
    dockerfilePath: Dockerfile
    envVars:
      - key: MYSQL_ROOT_PASSWORD
        value: root123
      - key: MYSQL_DATABASE
        value: itinventory_equip
      - key: MYSQL_USER
        value: itinv
      - key: MYSQL_PASSWORD
        value: itinv123
    disk:
      name: mysql-data
      mountPath: /var/lib/mysql
      sizeGB: 10

  # ----------------------------
  # Elasticsearch (Private Service)
  # (heap reduzido para evitar OOM)
  # ----------------------------
  - type: pserv
    name: itinventory-es
    runtime: image
    plan: starter
    autoDeploy: true
    image:
      url: docker.elastic.co/elasticsearch/elasticsearch:8.15.0
    startCommand: >
      /usr/local/bin/docker-entrypoint.sh
      -Ediscovery.type=single-node
      -Expack.security.enabled=false
    envVars:
      - key: ES_JAVA_OPTS
        value: "-Xms256m -Xmx256m"
    disk:
      name: es-data
      mountPath: /usr/share/elasticsearch/data
      sizeGB: 10

  # ----------------------------
  # Kibana (Web)
  # ----------------------------
  - type: web
    name: itinventory-kibana
    runtime: image
    plan: free
    autoDeploy: true
    image:
      url: docker.elastic.co/kibana/kibana:8.15.0
    envVars:
      - key: ELASTICSEARCH_HOSTS
        value: http://itinventory-es:9200

  # ----------------------------
  # ETL (Cron Job)
  # ----------------------------
  - type: cron
    name: itinventory-etl
    runtime: docker
    plan: starter
    autoDeploy: true
    schedule: "0 3 * * *"
    rootDir: docker/infra/etl
    dockerfilePath: Dockerfile
    envVars:
      - key: MYSQL_HOST
        value: itinventory-mysql
      - key: MYSQL_PORT
        value: "10000"
      - key: MYSQL_DB
        value: itinventory_equip
      - key: MYSQL_USER
        value: itinv
      - key: MYSQL_PASSWORD
        value: itinv123
      - key: ELASTIC_HOST
        value: http://itinventory-es:9200
      - key: ELASTIC_INDEX
        value: itinventory-equipments
